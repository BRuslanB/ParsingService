<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DATA TO DB</title>
</head>
<body onload="loadMain()">
</body>
<script type="text/javascript">

    function loadMain(){
        try {
            toGet();
            setTimeout(function() {
                location.reload();
            }, 300000);  // 5мин = 300000
        } catch (e) {
            alert("Error application!")
        }
    }

    function toGet() {
        // alert("toGet:"); //для проверки вызова
        const xhttp = new XMLHttpRequest();
        this.responseType = "document";
        var cont = "[]"; 
 
        xhttp.onload = function() {
            // console.log("get.status=" + this.status);
            if (this.status === 200) { //200-ok
                const result = this.responseText;
                // console.log("result="+result);
                if (result.includes('var punkts') && result.includes('var globalTown')) {
                    var s1 = result.indexOf('var punkts');
                    var s2 = result.indexOf('var globalTown');
                    cont = result.substring(s1, s2);
                    cont = cont.replaceAll('var punkts =', '');
                    cont = cont.replaceAll(' ', '');
                    cont = cont.replaceAll(';', '');
                    //console.log("cont"+cont);
                }
            } else {
               alert("Error load data!");
            }
            toPost(cont);
        }
 
        try {
            xhttp.open("GET","https://kurs.kz/");
            xhttp.send();
        } catch (e) {
            alert("Error access!")
        }
    }

    function toPost(cont){
        // alert("toPost:"); //для проверки вызова
        //console.log(cont);
        // var post = JSON.stringify(cont);
        var post = cont; //уже пришел как json
        var xhr = new XMLHttpRequest();
        //console.log(post);

        xhr.onload = function () {
            // console.log("post.status=" + this.status);
            if (this.status === 201 || this.status === 200) { //201-created
                alert("You have successfully send!");
            } else {
                alert("Error send!");
            }
        }

        try{
            xhr.open('POST', "http://localhost:8000/api", true);
            xhr.setRequestHeader('Content-type', 'application/json; charset=UTF-8');
            xhr.send(post);           
        } catch (e) {
            alert("Error conection!")
        }
    }

</script>
</html>